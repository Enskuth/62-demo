<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ß‡∏£</title>

<style>
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#c9e9ff,#fef6ff);
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:"Segoe UI",sans-serif;
}
.box{
  background:#fff;
  width:95%;
  max-width:700px;
  padding:25px;
  border-radius:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.15);
}
h1{
  text-align:center;
  margin-bottom:10px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid #ddd;
  padding:10px;
  text-align:center;
}
th{
  background:#f0f8ff;
}
img{
  width:80px;
  border-radius:10px;
}
.done{color:green;font-weight:bold}
.notyet{color:red}
button{
  padding:6px 10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.uploadBtn{background:#6dd5fa}
.teacherBtn{background:#fbc531}
.back{
  margin-top:15px;
  width:100%;
  background:#bbb;
}
</style>
</head>

<body>

<div class="box">
  <h1>üßπ ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ß‡∏£</h1>
  <div id="dayTitle"></div>

  <table>
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏£‡∏π‡∏õ‡πÄ‡∏ß‡∏£</th>
        <th>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏Ñ‡∏£‡∏π</th>
      </tr>
    </thead>
    <tbody id="dutyBody"></tbody>
  </table>

  <button class="back" onclick="location.href='index.html'">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</div>

<input type="file" id="fileInput" hidden>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD828fi7fnEuzeOvRbM6K1ESzcXRIZj8l8",
  authDomain: "money-c4c91.firebaseapp.com",
  projectId: "money-c4c91",
  storageBucket: "money-c4c91.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏£ */
const students = {
  mon:["‡∏û‡∏ß‡∏±‡∏•‡∏¢‡πå","‡∏ä‡∏•‡∏ì‡∏¥‡∏ä‡∏≤","‡∏ô‡∏£‡∏≤‡∏ó‡∏¥‡∏û‡∏¢‡πå","‡∏û‡∏á‡∏®‡πå‡∏û‡∏ì‡∏¥‡∏ä","‡∏î‡∏±‡∏™‡∏Å‡∏£"],
  tue:["‡∏™‡∏∏‡∏Å‡∏±‡∏ç‡∏ç‡∏≤","‡∏õ‡∏∏‡∏ì‡∏ß‡∏±‡∏à‡∏ô‡πå","‡∏™‡∏∏‡∏û‡∏±‡∏ï‡∏£‡∏≤","‡∏û‡∏™‡∏¥‡∏©‡∏ê‡πå","‡∏ß‡∏£‡∏≤‡∏¢‡∏∏‡∏ó‡∏ò‡πå"],
  wed:["‡∏£‡∏≤‡∏ä‡∏†‡∏π‡∏°‡∏¥","‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏¥‡∏ï","‡∏à‡∏±‡∏Å‡∏£‡∏Å‡∏¥‡∏ï","‡∏õ‡∏±‡∏ç‡∏ç‡∏≤"],
  thu:["‡∏≠‡∏ò‡∏¥‡∏Å‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏ï‡∏¥","‡∏£‡∏±‡∏ê‡∏†‡∏π‡∏°‡∏¥","‡∏û‡∏µ‡∏£‡∏¢‡∏∏‡∏ó‡∏ò‡πå","‡∏à‡∏±‡∏Å‡∏£‡∏¥‡∏ô","‡∏Å‡∏°‡∏•‡∏ß‡∏£‡∏£‡∏ì"],
  fri:["‡∏ì‡∏±‡∏ê‡∏ò‡∏ß‡∏±‡∏ä","‡∏®‡∏∏‡∏†‡∏Å‡∏£","‡∏û‡∏µ‡∏£‡∏∞‡πÄ‡∏î‡∏ä","‡∏≠‡∏î‡∏¥‡πÄ‡∏ó‡∏û","‡∏ô‡∏¥‡∏û‡∏¥‡∏ê‡∏û‡∏ô‡∏ò‡πå"]
};

const dayMap = ["sun","mon","tue","wed","thu","fri","sat"];
const todayKey = dayMap[new Date().getDay()];
const dayTH = {mon:"‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå",tue:"‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£",wed:"‡∏û‡∏∏‡∏ò",thu:"‡∏û‡∏§‡∏´‡∏±‡∏™",fri:"‡∏®‡∏∏‡∏Å‡∏£‡πå"};

document.getElementById("dayTitle").innerHTML = `‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô <b>${dayTH[todayKey]||"‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£"}</b>`;

const tbody = document.getElementById("dutyBody");

async function loadDuty(){
  if(!students[todayKey]) return;

  const refDoc = doc(db,"duty",todayKey);
  const snap = await getDoc(refDoc);
  const data = snap.exists()? snap.data():{};

  tbody.innerHTML="";
  students[todayKey].forEach(name=>{
    const info = data[name] || {};
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${name}</td>
      <td>${info.image? `<img src="${info.image}">`:"-"}</td>
      <td><button class="uploadBtn">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button></td>
      <td class="${info.done?'done':'notyet'}">${info.done?'‚úî ‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß':'‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥'}</td>
      <td><button class="teacherBtn">‡∏ï‡∏¥‡πä‡∏Å</button></td>
    `;

    tr.querySelector(".uploadBtn").onclick = ()=> uploadImage(name);
    tr.querySelector(".teacherBtn").onclick = ()=> teacherCheck(name);

    tbody.appendChild(tr);
  });
}

let currentName="";
function uploadImage(name){
  currentName=name;
  document.getElementById("fileInput").click();
}

document.getElementById("fileInput").onchange = async e=>{
  const file = e.target.files[0];
  if(!file) return;

  const storageRef = ref(storage,`duty/${todayKey}/${currentName}.jpg`);
  await uploadBytes(storageRef,file);
  const url = await getDownloadURL(storageRef);

  await setDoc(doc(db,"duty",todayKey),{
    [currentName]:{ image:url, done:false }
  },{merge:true});

  loadDuty();
};

async function teacherCheck(name){
  const pass = prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π");
  if(pass!=="1234") return alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

  await updateDoc(doc(db,"duty",todayKey),{
    [`${name}.done`]:true
  });
  loadDuty();
}

loadDuty();
</script>

</body>
</html>
